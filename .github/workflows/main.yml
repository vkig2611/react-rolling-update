name: Rolling Update Frontend App

on:
  push:
    branches:
      - main  # Trigger deployment when pushing to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: SSH into Server and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            IMAGE_NAME="${{ secrets.DOCKER_HUB_USERNAME }}/roll-update:v2"

            echo "Pulling latest v2 image..."
            docker pull $IMAGE_NAME

            # Check if service exists
            if ! docker service ls | grep -q roll-update; then
              echo "Service 'roll-update' not found. Creating service..."
              docker service create \
                --name roll-update \
                --replicas 2 \
                --publish 3003:80 \
                --update-parallelism 1 \
                --update-delay 10s \
                $IMAGE_NAME
            else
              echo "Service 'roll-update' found. Performing rolling update..."
              docker service update \
                --image $IMAGE_NAME \
                --update-parallelism 1 \
                --update-delay 10s \
                roll-update
            fi
